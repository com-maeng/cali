services:
  was:
    build:
      context: ./cali_backend
      dockerfile: Dockerfile
    volumes:
      - "./cali_backend:/cali:ro"
    ports:
      - "127.0.0.1:8000:8000"
    env_file: ".env.dev"
    environment:
      - DEBUG=1
      - DJANGO_SETTINGS_MODULE=cali_backend.settings # manage.py에서 setdefault 메서드 호출해도 환경변수 설정이 안 됨
    depends_on:
      db:
        condition: service_healthy

  db:
    image: postgres:16-alpine3.20 # Latest minor version
    environment:
      - POSTGRES_DB=${DATABASE_NAME}
      - POSTGRES_USER=${DATABASE_USER}
      - POSTGRES_PASSWORD=${DATABASE_PASSWORD}
    ports:
      - "5432:5432"
    healthcheck:
      test: "pg_isready --username=${DATABASE_USER} --dbname=${DATABASE_NAME}"
      interval: 2s
      retries: 4
      start_period: 2s
      timeout: 4s
    volumes:
      - "cali-db-data:/var/lib/postgresql/data"

volumes:
  cali-db-data:
  cali-cache-data:
# networks: # 지금은 불필요할 듯
#   cali-network:
